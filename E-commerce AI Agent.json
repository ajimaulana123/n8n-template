{
  "name": "E-commerce AI Agent",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -1408,
        480
      ],
      "id": "a656fb36-fb87-4711-9d92-2b9b3920f877",
      "name": "Customer",
      "webhookId": "78914521-a6f5-4df2-962d-f854756f30b4",
      "credentials": {
        "telegramApi": {
          "id": "KW13IVb7XC1oKAE4",
          "name": "notf buat customer"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "11hqFwEM0pL8P7tE44n5HjLXO5d1zyqRAlygkSUGpm78",
          "mode": "list",
          "cachedResultName": "Products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11hqFwEM0pL8P7tE44n5HjLXO5d1zyqRAlygkSUGpm78/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11hqFwEM0pL8P7tE44n5HjLXO5d1zyqRAlygkSUGpm78/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        -704,
        704
      ],
      "id": "1f885c75-8830-4650-900f-b1664e6a7130",
      "name": "get products",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "IW67FNytlHFhHHc0",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Customer').first().json.message.text }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=\nAnda adalah **asisten virtual Toko Kaos Dedi**, toko online yang menjual berbagai jenis kaos pria dan wanita. Tugas Anda adalah **membantu pelanggan melalui WhatsApp** dengan memberikan informasi produk secara **akurat, lengkap, dan ramah**, berdasarkan data yang tersimpan di Google Sheets.\n\n### **Format Output**\n\nSemua respons harus dalam **format JSON** berikut:\n\n```json\n{\n  \"tanggal\": \"yyyy-MM-dd HH:mm:ss\",\n  \"status\": \"...\",\n  \"response_to_customer\": \"...\"\n}\n```\n\n**Keterangan kolom:**\n\n* `tanggal`: Waktu saat ini di **zona WIB (UTC+7)**.\n* `status`: Jenis permintaan pelanggan, pilih salah satu:\n\n  1. `keluhan: [isi keluhan]`\n  2. `detail: [nama produk]`\n  3. `umum: [deskripsi singkat]` (untuk sapaan, daftar produk, kontak, input tidak jelas, dll.)\n* `response_to_customer`: Respons ramah sesuai jenis permintaan.\n\n> Semua JSON harus disimpan di Google Sheets menggunakan **fungsi append row** ke kolom `tanggal`, `status`, dan `response_to_customer`.\n\n---\n\n### **Aturan Penanganan Pesan Pelanggan**\n\n1. **Permintaan Detail Produk Spesifik**\n\n   * Contoh: `\"Kaos Polos Hitam\"`, `\"detail Kaos Oversize Putih\"`.\n   * **Langkah:**\n\n     1. Gunakan `get_product_info` untuk mengambil data produk (nama, harga, stok, gambar\\_1‚Äìgambar\\_10).\n     2. Susun informasi dalam format **rapi dan terstruktur**:\n\n```\nBerikut informasi detail untuk produk [Nama Produk]:\nNama Produk: [produk]\nHarga: Rp[Harga]\nStok Tersedia: [stok] pcs\nFoto:\n[gambar_url_1]\n[gambar_url_2]\n...\n```\n\n* Jika gambar kosong, jangan tampilkan bagian tersebut.\n* Jika produk tidak ditemukan: `\"Maaf, produk tidak ditemukan.\"`\n* Jika tool gagal: `\"Maaf, terjadi kesalahan saat mengambil data produk. Silakan hubungi admin kami.\"`\n* **status**: `\"detail: [nama produk]\"`\n\n---\n\n2. **Permintaan Daftar Produk Umum**\n\n   * Contoh: `\"Produk apa yang kamu punya?\"`, `\"Daftar produk?\"`\n   * **Langkah:**\n\n     1. Gunakan `get_all_product_data` untuk mengambil semua produk (nama + harga).\n     2. Susun daftar **berurutan**:\n\n```\nBerikut adalah daftar semua produk kaos yang tersedia:\n1. Kaos Polos Hitam - Rp75.000\n2. Kaos Oversize Putih - Rp85.000\n3. Kaos Distro Navy - Rp95.000\n...\n```\n\n* Jangan tampilkan stok atau URL gambar.\n* Jika tidak ada produk: `\"Saat ini tidak ada produk yang tersedia.\"`\n* **status**: `\"umum: daftar produk\"`\n\n---\n\n3. **Permintaan Kontak atau Lokasi**\n\n   * Contoh: `\"Alamat?\"`, `\"Lokasi toko?\"`, `\"Kontak admin?\"`\n   * **Respons**:\n\n```\nInformasi Toko:\nLokasi: Toko Kaos Dedi, Jakarta\nGoogle Maps: https://www.google.com/maps/place/Pasar+Minggu+Kota+Malang/@-7.9791627,112.6168778,15z/\n```\n\n* **status**: `\"umum: kontak/lokasi\"`\n\n---\n\n4. **Sapaan atau Perkenalan**\n\n   * Contoh: `\"Halo\"`, `\"Kamu siapa?\"`, `\"Boleh nanya?\"`\n   * **Respons**:\n     `\"Halo! Saya adalah asisten informasi produk kaos dari Toko Kaos Dedi. Ada yang bisa saya bantu?\"`\n   * **status**: `\"umum: sapaan\"`\n\n---\n\n5. **Input Tidak Jelas atau Kosong**\n\n   * Jika pesan pelanggan tidak bisa diidentifikasi atau kosong:\n   * **Respons**:\n     `\"Maaf, saya tidak mengerti pesan Anda. Bisa dijelaskan lebih rinci?\"`\n   * **status**: `\"umum: input tidak jelas\"`\n\n---\n\n6. **Validasi & Error Handling**\n\n   * Selalu **cek data kosong** sebelum menampilkan.\n   * Jika tool (`get_product_info`, `get_all_product_data`) gagal, gunakan:\n     `\"Maaf, terjadi kesalahan saat mengambil data produk. Silakan hubungi admin kami.\"`\n\n---\n\n7. **Keluhan / Komplain Pelanggan**\n\n* **Contoh**: `\"Pesanan saya terlambat\"`, `\"Kaos yang dikirim rusak\"`\n* **Respons Ramah & Empati dengan Kontak**:\n\n```\nMaaf atas ketidaknyamanan yang Anda alami üòî. Tim Toko Kaos Dedi akan segera menindaklanjuti keluhan Anda. \nMohon informasikan nomor pesanan atau detail masalah agar kami bisa membantu lebih cepat.\n\nüìû Kontak Admin:\nWhatsApp: +62 812-3456-7890\nEmail: admin@tokokaosdedi.com\n```\n\n* **status**: `\"keluhan: [ringkasan keluhan]\"`\n* Selalu:\n\n  1. Sampaikan empati.\n  2. Minta info tambahan jika perlu (misal nomor pesanan).\n  3. Sertakan kontak agar pelanggan bisa langsung dihubungi.\n\n---\n\n\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -848,
        480
      ],
      "id": "474b3cfd-42f2-4de0-81d1-b648f9651509",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Customer').first().json.message.chat.id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -832,
        704
      ],
      "id": "d1aeae94-302b-47cf-bae1-f5cc2851e061",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -960,
        704
      ],
      "id": "3abfae19-1696-4c99-b34c-beb7cb6c5ca7",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "yuJXiA4DUil7A6J9",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Customer').first().json.message.chat.id }}",
        "text": "‚è≥ Tunggu ya...",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1184,
        480
      ],
      "id": "31e8859d-0264-4e4b-9319-750a87db9af9",
      "name": "Loading",
      "webhookId": "a0946c20-45ce-4ea7-a360-c5bb903cee34",
      "credentials": {
        "telegramApi": {
          "id": "KW13IVb7XC1oKAE4",
          "name": "notf buat customer"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Customer').first().json.message.chat.id }}",
        "text": "={{ $('AI Agent1').first().json.output.response_to_customer }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        80,
        288
      ],
      "id": "12504b0b-affc-4a3f-bcc8-bc968dc60509",
      "name": "Message for Customer",
      "webhookId": "a0946c20-45ce-4ea7-a360-c5bb903cee34",
      "credentials": {
        "telegramApi": {
          "id": "KW13IVb7XC1oKAE4",
          "name": "notf buat customer"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://drive.google.com/uc?export=download&id={{ $('Get url image').first().json.idImage }}",
        "options": {
          "response": {}
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        528,
        480
      ],
      "id": "0aaaf151-7f1d-4a97-9700-e1a08b34a7f0",
      "name": "body_req"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Filter Status Message').first().json.status }}",
                    "rightValue": "umum",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "1ea131a7-7545-4695-bd83-685e4e04c96d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "umum"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "49e9446a-2611-4b2e-b318-dc3d50ae3daf",
                    "leftValue": "={{ $('Filter Status Message').first().json.status }}",
                    "rightValue": "detail",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "detail"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "4cbd76b9-44ee-471b-9edb-a7769f26ad05",
                    "leftValue": "={{ $('Filter Status Message').first().json.status }}",
                    "rightValue": "keluhan",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "keluhan"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -144,
        464
      ],
      "id": "5270c467-214b-4d99-8ce1-7f4227c9ecd4",
      "name": "Menu"
    },
    {
      "parameters": {
        "jsCode": "const status = $('AI Agent1').first().json.output.status.split(\":\")\n\nreturn { status: status[0] }\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -368,
        480
      ],
      "id": "2dbfe3a0-d6a4-4e39-bbf2-c6da5ee3bd6e",
      "name": "Filter Status Message"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"tanggal\": \"2025-09-07 16:32:00\",\n  \"status\": \"Keluhan: Kaos Polos Hitam sobek di bagian lengan.\",\n  \"response_to_customer\": \"Halo, terima kasih sudah menghubungi Toko Kaos Dedi. Kami mohon maaf atas ketidaknyamanan karena kaos yang sobek. Keluhan Anda telah kami catat dan akan segera ditindaklanjuti oleh tim kami. Mohon tunggu konfirmasi lebih lanjut ya!\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -576,
        704
      ],
      "id": "863555d4-1552-4f48-bb2c-ff33269c86e9",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "jsCode": "// Ambil 1 produk saja (misal produk pertama)\nconst urlImage =  $('AI Agent1').first().json.output.response_to_customer.match(/\\/file\\/d\\/(.+?)\\/.*/);\n\nconst idImage = urlImage[1]\n\nreturn { idImage }"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        480
      ],
      "id": "a1447b28-6aa7-4545-8cc4-6934575af7d0",
      "name": "Get url image"
    },
    {
      "parameters": {
        "operation": "sendPhoto",
        "chatId": "={{ $('Customer').first().json.message.chat.id }}",
        "binaryData": true,
        "replyMarkup": "forceReply",
        "forceReply": {},
        "additionalFields": {
          "caption": "={{ $('Build Message').first().json.cleanedText }}",
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        752,
        480
      ],
      "id": "b2ece258-6090-4dc7-bad6-33edd6140f91",
      "name": "Send a photo product to Customer",
      "webhookId": "a036e535-de72-4193-9988-54cad8623080",
      "credentials": {
        "telegramApi": {
          "id": "KW13IVb7XC1oKAE4",
          "name": "notf buat customer"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let text = $('AI Agent1').first().json.output.response_to_customer\n// Hapus URL Google Drive\ntext = text.replace(/https:\\/\\/drive\\.google\\.com\\/file\\/d\\/.+?\\/view\\?usp=sharing/g, '');\n\n// Optional: hapus baris kosong yang tersisa\ntext = text.split('\\n').filter(line => line.trim() !== '').join('\\n');\n\ntext = `${text}\\nhttps://drive.google.com/file/d/${$('Get url image').first().json.idImage}/view\n`\n\n// Output\nreturn {\n  cleanedText: text\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        304,
        480
      ],
      "id": "b49a8a05-733b-480e-959e-a2488753d3a3",
      "name": "Build Message"
    },
    {
      "parameters": {
        "chatId": "={{ $('Customer').first().json.message.chat.id }}",
        "text": "={{ $('AI Agent1').first().json.output.response_to_customer }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        80,
        672
      ],
      "id": "8fb9c29b-9414-485e-be70-54fe64e79d7a",
      "name": "Complaints",
      "webhookId": "a0946c20-45ce-4ea7-a360-c5bb903cee34",
      "credentials": {
        "telegramApi": {
          "id": "KW13IVb7XC1oKAE4",
          "name": "notf buat customer"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "11hqFwEM0pL8P7tE44n5HjLXO5d1zyqRAlygkSUGpm78",
          "mode": "list",
          "cachedResultName": "Products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11hqFwEM0pL8P7tE44n5HjLXO5d1zyqRAlygkSUGpm78/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 466824431,
          "mode": "list",
          "cachedResultName": "Keluhan",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11hqFwEM0pL8P7tE44n5HjLXO5d1zyqRAlygkSUGpm78/edit#gid=466824431"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Tanggal": "={{ $('AI Agent1').first().json.output.tanggal }}",
            "Keluhan": "={{ $('AI Agent1').first().json.output.keluhan }}",
            "chatId": "={{ $('Customer').first().json.message.chat.id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Tanggal",
              "displayName": "Tanggal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Keluhan",
              "displayName": "Keluhan",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chatId",
              "displayName": "chatId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        304,
        672
      ],
      "id": "67d6850d-28c5-4dee-983a-992c0061f90e",
      "name": "Append row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "IW67FNytlHFhHHc0",
          "name": "Google Sheets account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Customer": {
      "main": [
        [
          {
            "node": "Loading",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get products": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Loading": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Filter Status Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message for Customer": {
      "main": [
        []
      ]
    },
    "Filter Status Message": {
      "main": [
        [
          {
            "node": "Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Menu": {
      "main": [
        [
          {
            "node": "Message for Customer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get url image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Complaints",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "body_req": {
      "main": [
        [
          {
            "node": "Send a photo product to Customer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Get url image": {
      "main": [
        [
          {
            "node": "Build Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Message": {
      "main": [
        [
          {
            "node": "body_req",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Complaints": {
      "main": [
        [
          {
            "node": "Append row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "7750641b-5884-4604-a853-ba5f542967d8",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "46a29db62999dc606f5f1e3377f5efc0323ffceb350942210893f894d66ccfa3"
  },
  "id": "PW4eDyeA8PELr2Hk",
  "tags": []
}